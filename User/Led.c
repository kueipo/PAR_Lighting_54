#include "Led.h"
#include "Main.h"
#include "LEDFunc.h"
DRIVER Driver;
unsigned short wLedDebugValue1,wLedDebugValue2,wLedDebugValue3;
extern const unsigned char cTabHoldColor[];


unsigned short const wTab_R[] = // P2(115,115) P3(120,120)
{
	    0,  
	    4,    5,    6,    8,    9,   10,   11,   13,   14,   15,   16,   18,   19,   20,   21,   23,
	   24,   25,   26,   28,   29,   30,   31,   33,   34,   35,   36,   37,   39,   40,   41,   42,
	   44,   45,   46,   47,   49,   50,   51,   52,   54,   55,   56,   57,   59,   60,   61,   62,
	   64,   65,   66,   67,   69,   70,   71,   72,   74,   75,   76,   77,   79,   80,   81,   82,
	   84,   85,   86,   87,   88,   90,   91,   92,   93,   95,   96,   97,   98,  100,  101,  102,
	  103,  105,  106,  107,  108,  110,  111,  112,  113,  115,  116,  117,  118,  120,  121,  122,
	  123,  125,  126,  127,  128,  130,  131,  132,  133,  135,  136,  137,  138,  140,  141,  142,
	  143,  144,  146,  147,  148,  149,  151,  152,  153,  154,  156,  157,  158,  159,  161,  162,
	  163,  164,  166,  167,  168,  169,  171,  172,  173,  174,  176,  177,  178,  179,  181,  182,
	  183,  184,  186,  187,  188,  189,  191,  192,  193,  194,  195,  197,  198,  199,  200,  202,
	  203,  204,  205,  207,  208,  209,  210,  212,  213,  214,  215,  217,  218,  219,  220,  222,
	  223,  224,  225,  227,  228,  229,  230,  232,  233,  234,  235,  237,  238,  239,  240,  242,
	  243,  244,  245,  246,  248,  249,  250,  251,  253,  254,  255,  256,  258,  259,  260,  261,
	  263,  264,  265,  266,  268,  269,  270,  271,  273,  274,  275,  276,  278,  279,  280,  281,
	  283,  284,  285,  286,  288,  289,  290,  291,  293,  294,  295,  296,  298,  299,  300,  301,
	  302,  304,  305,  306,  307,  309,  310,  311,  312,  314,  315,  316,  317,  319,  320,
};
unsigned short const wTab_G[] = // P2(115,115) P3(120,120)
{
	    0,  
	    4,   12,   20,   27,   35,   43,   51,   59,   67,   75,   82,   90,   98,  106,  114,  122,
	  130,  137,  145,  153,  161,  169,  177,  185,  192,  200,  208,  216,  224,  232,  240,  248,
	  255,  263,  271,  279,  287,  295,  303,  310,  318,  326,  334,  342,  350,  358,  365,  373,
	  381,  389,  397,  405,  413,  420,  428,  436,  444,  452,  460,  468,  475,  483,  491,  499,
	  507,  515,  523,  530,  538,  546,  554,  562,  570,  578,  585,  593,  601,  609,  617,  625,
	  633,  640,  648,  656,  664,  672,  680,  688,  695,  703,  711,  719,  727,  735,  743,  750,
	  758,  766,  774,  782,  790,  798,  805,  813,  821,  829,  837,  845,  853,  860,  868,  876,
	  884,  892,  900,  908,  915,  923,  931,  939,  947,  955,  963,  970,  978,  986,  994, 1002,
	 1010, 1018, 1025, 1033, 1041, 1049, 1057, 1065, 1073, 1080, 1088, 1096, 1104, 1112, 1120, 1128,
	 1135, 1143, 1151, 1159, 1167, 1175, 1183, 1190, 1198, 1206, 1214, 1222, 1230, 1238, 1246, 1253,
	 1261, 1269, 1277, 1285, 1293, 1301, 1308, 1316, 1324, 1332, 1340, 1348, 1356, 1363, 1371, 1379,
	 1387, 1395, 1403, 1411, 1418, 1426, 1434, 1442, 1450, 1458, 1466, 1473, 1481, 1489, 1497, 1505,
	 1513, 1521, 1528, 1536, 1544, 1552, 1560, 1568, 1576, 1583, 1591, 1599, 1607, 1615, 1623, 1631,
	 1638, 1646, 1654, 1662, 1670, 1678, 1686, 1693, 1701, 1709, 1717, 1725, 1733, 1741, 1748, 1756,
	 1764, 1772, 1780, 1788, 1796, 1803, 1811, 1819, 1827, 1835, 1843, 1851, 1858, 1866, 1874, 1882,
	 1890, 1898, 1906, 1913, 1921, 1929, 1937, 1945, 1953, 1961, 1968, 1976, 1984, 1992, 2000,
};

unsigned short const wTab_B[] = // P2(115,115) P3(120,120)
{
	    0, 
    	4,   12,   20,   27,   35,   43,   51,   59,   67,   75,   82,   90,   98,  106,  114,  122,
	  130,  137,  145,  153,  161,  169,  177,  185,  192,  200,  208,  216,  224,  232,  240,  248,
	  255,  263,  271,  279,  287,  295,  303,  310,  318,  326,  334,  342,  350,  358,  365,  373,
	  381,  389,  397,  405,  413,  420,  428,  436,  444,  452,  460,  468,  475,  483,  491,  499,
	  507,  515,  523,  530,  538,  546,  554,  562,  570,  578,  585,  593,  601,  609,  617,  625,
	  633,  640,  648,  656,  664,  672,  680,  688,  695,  703,  711,  719,  727,  735,  743,  750,
	  758,  766,  774,  782,  790,  798,  805,  813,  821,  829,  837,  845,  853,  860,  868,  876,
	  884,  892,  900,  908,  915,  923,  931,  939,  947,  955,  963,  970,  978,  986,  994, 1002,
	 1010, 1018, 1025, 1033, 1041, 1049, 1057, 1065, 1073, 1080, 1088, 1096, 1104, 1112, 1120, 1128,
	 1135, 1143, 1151, 1159, 1167, 1175, 1183, 1190, 1198, 1206, 1214, 1222, 1230, 1238, 1246, 1253,
	 1261, 1269, 1277, 1285, 1293, 1301, 1308, 1316, 1324, 1332, 1340, 1348, 1356, 1363, 1371, 1379,
	 1387, 1395, 1403, 1411, 1418, 1426, 1434, 1442, 1450, 1458, 1466, 1473, 1481, 1489, 1497, 1505,
	 1513, 1521, 1528, 1536, 1544, 1552, 1560, 1568, 1576, 1583, 1591, 1599, 1607, 1615, 1623, 1631,
	 1638, 1646, 1654, 1662, 1670, 1678, 1686, 1693, 1701, 1709, 1717, 1725, 1733, 1741, 1748, 1756,
	 1764, 1772, 1780, 1788, 1796, 1803, 1811, 1819, 1827, 1835, 1843, 1851, 1858, 1866, 1874, 1882,
	 1890, 1898, 1906, 1913, 1921, 1929, 1937, 1945, 1953, 1961, 1968, 1976, 1984, 1992, 2000,
};



/*****************************************LEDÇý¶¯****************************************************/

void LedDimmerProc(unsigned short *NowValue, unsigned short *EndValue,unsigned short *p,
										unsigned short *Count,unsigned short *DmxValue)
{
	unsigned short w1;
	unsigned short d_value;
	
	if((*NowValue) != (*EndValue))
	{
		if((*NowValue)>(*EndValue))
		{
			d_value = (*NowValue)-(*EndValue);
			
			if (d_value < 10000)
				w1 = ((unsigned long)d_value * d_value) / 10000 + 1;
			else
				w1 = 16000;

			if ((*p) != w1)
			{
				if ((*p) > w1)
					(*p) -= 1;
				else 
				{
					if (d_value >= 300)
						(*p) = w1;
					else
						(*p) +=	1;	
				}
			}

			if (d_value < (*p))
				(*NowValue) -=d_value;
			else
				(*NowValue) -=(*p);
		}
		
		else
		{
			d_value = (*EndValue)-(*NowValue);
			if (d_value < 10000)//12311
			{
				w1 = ((unsigned long)d_value * d_value) / 10000 + 1;//
			}
			else
			{
				w1 = 16000;//16659
			}
			if ((*p) != w1)
			{
				if ((*p) > w1)
				{
					(*p) -= 1;
				}
				else 
				{
					if (d_value >= 300)
					{	
						(*p) = w1;
					}
					else
					{
						(*p) +=	1;	
					}
				}
			}

			if (d_value < (*p))
			{
				(*NowValue) +=d_value;
			}
			else
			{
				(*NowValue) +=(*p);
			}
		}
	}
}
void LedDriver(void)
{
	unsigned char c;
//	unsigned short w;
	unsigned char cValue;
	
	Driver.wEndLum[0] = wTab_R[LED.CutRGB_Buf[LED_R]];
	Driver.wEndLum[1] = wTab_G[LED.CutRGB_Buf[LED_G]];
	Driver.wEndLum[2] = wTab_B[LED.CutRGB_Buf[LED_B]];
	
	if(LED.bShutter)
	{
		TIM1->CCR1 = Driver.wEndLum[0];
		TIM1->CCR3 = Driver.wEndLum[1];
		TIM1->CCR2 = Driver.wEndLum[2];
	}
	else
	{
		for(c=0;c<3;c++)
		{
			LedDimmerProc(Driver.wNowLum+c,Driver.wEndLum+c,Driver.wNowSpeed + c,Driver.wLumCount + c,Driver.wDmxValue + c);
			
			if (Driver.wNowLum[c] == Driver.wEndLum[c])
				Driver.wNowSpeed[c] = 0;

		}
		
		TIM1->CCR1 = Driver.wNowLum[0];
		TIM1->CCR3 = Driver.wNowLum[1];
		TIM1->CCR2 = Driver.wNowLum[2];
	}
}
